// SPDX-FileCopyrightText: 2025 Jo√£o V. Farias (beyondmagic) <beyondmagic@mail.ru>
// SPDX-License-Identifier: AGPL-3.0-or-later

// Types

Enum "TYPE_DOMAIN" {
    "ROUTER"
    "SUBDOMAIN"
}

Enum "TYPE_STATUS" {
    "PUBLIC"
    "PRIVATE"
    "ARCHIVED"
    "DELETED"
}

Enum "TYPE_ADAPTER" {
    "HTTP"
    "ACTION"
}

// Area: Auditory

Table "Request" {
  "id" serial [pk, not null, increment]
  "id_content" bigint [not null, ref: < "Content"."id"]
  "ip" varchar(500) [not null]
  "device" varchar(500) [not null]
  "time" timestamp [not null]
}

// Area: Garden

Table "Garden_Information" {
  "id" bigint [pk, not null]
  "id_garden" bigint [not null, ref: < "Garden"."id"]
  "id_language" varchar(500) [not null, ref: < "Language"."id"]
  "name" varchar(500) [not null]
  "description" text [not null]

  Indexes {
    (id_garden, id_language) [unique]
  }
}

Table "Garden" {
  "id" bigint [pk, not null]
  "id_domain" bigint [unique, not null, note: 'The root subdomain of the Garden.', ref: < "Domain"."id"]
  "id_asset" bigint [unique, not null, ref: < "Asset"."id"]
}

// Area: Language

Table "Language_Information" {
  "id" bigint [pk, not null]
  "id_for" varchar(500) [not null, ref: < "Language"."id"]
  "id_from" varchar(500) [not null, ref: < "Language"."id"]
  "name" varchar(500) [not null]
  "description" text [not null]

  Indexes {
    (id_for, id_from) [unique]
  }
}

Table "Language" {
  "id" varchar(500) [pk, not null]
  "id_asset" bigint [unique, not null, ref: < "Asset"."id"]
}

// Area: Tag

Table "Tag" {
  "id" bigint [pk, not null]
  "id_asset" bigint [ref: < "Asset"."id"]
}

Table "Tag_Requirement" {
  "id" bigint [pk, not null]
  "id_tag" bigint [not null, ref: < "Tag"."id"]
  "id_tag_for" bigint [not null, ref: < "Tag"."id"]

  Indexes {
    (id_tag, id_tag_for) [unique]
  }
}

Table "Domain_Tag" {
  "id" bigint [pk, not null]
  "id_domain" bigint [not null, ref: < "Domain"."id"]
  "id_tag" bigint [not null, ref: < "Tag"."id"]
}

Table "Tag_Information" {
  "id" bigint [pk, not null]
  "id_tag" bigint [not null, ref: < "Tag"."id"]
  "id_language" varchar(500) [not null, ref: < "Language"."id"]
  "name" varchar(500) [not null]
  "description" text [not null]

  Indexes {
    (id_tag, id_language) [unique]
  }
}

// Area: Module

Table "Module" {
  "id" bigint [pk, not null]
  // If a path, then link `ln` to local filesystem; if a link, then git clone.
  "repository" varchar(512) [unique, not null, note: 'Either a path or a link to a git repository.']
  "slug" varchar(8) [unique, not null, note: 'Human-chosen identifier (e.g. petalize, notifications).']
  "enabled" boolean [not null]
  "last_checked" timestamp [not null]
  "commit" varchar(40) [not null]
  "branch" varchar(256) [not null]
}

Table "Module_Binding" {
  "id" bigint [pk, not null]
  "id_garden" bigint [not null, ref: < "Garden"."id"]

  // Target selection:
  // If null, applies to all domains in the garden.
  // If set, applies only to the specified domain.
  "id_domain_target" bigint [ref: < "Domain"."id"]

  "adapter" TYPE_ADAPTER [not null]

  "recursive" boolean [not null]
  "enabled" boolean [not null]

  // Identify the capability to dispatch to (runtime will validate existence)
  "slug_module" varchar(8) [not null, ref: < "Module"."slug"]
  "slug_capability" varchar(8) [not null]

  // Optional allow-list of HTTP methods.
  // Recommended encoding: comma-separated upper-case values (e.g. "GET,POST").
  "methods" varchar(128)

  // Tie-breaker when two bindings are equally specific.
  "priority" int [not null, default: 0]

  Indexes {
    (id_garden, enabled)
    (id_garden, id_domain_target)
    (id_garden, slug_module)
  }
}

// Area: Domain

Table "Domain" {
  "id" bigint [pk, not null]
  "id_domain_parent" bigint [ref: < "Domain"."id"]
  "id_domain_redirect" bigint [ref: < "Domain"."id"]
  "type" TYPE_DOMAIN [not null]
  "name" varchar(500) [not null]
  "status" TYPE_STATUS [not null]

  Indexes {
    // A parent domain can only have one subdomain of a given name and type.
    (id_domain_parent, type, name) [unique]
  }
}

Table "Content" {
  "id" bigint [pk, not null]
  "id_domain" bigint [not null, ref: < "Domain"."id"]
  "id_language" varchar(500) [not null, ref: < "Language"."id"]
  "status" TYPE_STATUS [not null]
  "title" varchar(500)
  "title_sub" varchar(500)
  "synopsis" varchar(500)
  "body" text
  "requests" bigint [not null]

  Indexes {
    (id_domain, id_language) [unique]
  }
}

Table "Content_Link" {
  "id" bigint [pk, not null]
  "id_from" bigint [not null, ref: < "Content"."id"]
  "id_to" bigint [not null, ref: < "Content"."id"]

  Indexes {
    (id_from, id_to) [unique]
  }
}

// Area: Asset

Table "Asset" {
  "id" bigint [pk, not null]
  "id_domain" bigint [unique, not null, ref: < "Domain"."id"]
  "name" varchar(500) [unique, not null]
  "extension" varchar(500)
}

Table "Asset_Information" {
  "id" bigint [pk, not null]
  "id_asset" bigint [not null, ref: < "Asset"."id"]
  "id_language" varchar(500) [not null, ref: < "Language"."id"]
  "name" varchar(500) [not null]
  "description" text [not null]

  Indexes {
    (id_asset, id_language) [unique]
  }
}

// Area: Authors

Table "Author" {
  "id" bigint [pk, not null]
  "id_asset" bigint [not null, ref: < "Asset"."id"]
  "email" varchar(500) [unique, not null]
  "name" varchar(500) [not null]
  "password" varchar(500) [not null, note: 'Hashed password (e.g., bcrypt/argon2); never store plaintext here']
  "pages" bigint [not null]
  "contents" bigint [not null]
}

Table "Author_Connections" {
  "id" bigint [pk, not null]
  "id_author" bigint [not null, ref: < "Author"."id"]
  "device" varchar(500) [not null]
  "token" varchar(500) [unique, not null]
  "logged_at" timestamp [not null]
  "last_connection" timestamp [not null]
}

Table "Authored_Domain" {
  "id" bigint [pk, not null]
  "id_author" bigint [not null, ref: < "Author"."id"]
  "id_domain" bigint [not null, ref: < "Domain"."id"]

  Indexes {
    (id_author, id_domain) [unique]
  }
}

Table "Authored_Content" {
  "id" bigint [pk, not null]
  "id_author" bigint [not null, ref: < "Author"."id"]
  "id_content" bigint [not null, ref: < "Content"."id"]

  Indexes {
    (id_author, id_content) [unique]
  }
}

Table "Authored_Garden" {
  "id" bigint [pk, not null]
  "id_author" bigint [not null, ref: < "Author"."id"]
  "id_garden" bigint [not null, ref: < "Garden"."id"]
  Indexes {
     (id_author, id_garden) [unique]
  }
}
